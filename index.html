<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SewaAstra Partner - Universe Edition</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --p: #ff6b00; --s: #0f172a; --bg: #f8fafc; --grad: linear-gradient(135deg, #ff6b00, #ff9e00); }
        body { background: var(--bg); font-family: 'Outfit', sans-serif; transition: 0.3s; }
        
        /* Preloader */
        #preloader { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* Layout */
        .page { display: none; min-height: 100vh; padding-bottom: 100px; animation: fadeIn 0.4s ease-in-out; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Elements */
        .u-card { background: white; border-radius: 28px; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 10px 30px rgba(0,0,0,0.02); padding: 25px; margin-bottom: 20px; }
        .wallet-master { background: var(--s); color: white; border-radius: 35px; padding: 35px; position: relative; overflow: hidden; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2); }
        .wallet-master::before { content: ''; position: absolute; top: -20%; right: -10%; width: 180px; height: 180px; background: var(--p); filter: blur(70px); opacity: 0.3; }
        
        /* Job Status UI */
        .status-pill { font-size: 10px; font-weight: 800; padding: 6px 14px; border-radius: 50px; text-transform: uppercase; }
        .st-open { background: #fff7ed; color: #ea580c; }
        .st-active { background: #ecfdf5; color: #10b981; }
        
        /* Buttons */
        .btn-sewa { background: var(--grad); color: white; border: none; border-radius: 20px; padding: 16px; width: 100%; font-weight: 800; box-shadow: 0 10px 20px rgba(255,107,0,0.3); transition: 0.3s; }
        .btn-sewa:active { transform: scale(0.96); }
        
        /* Bottom Navigation */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-radius: 25px; display: flex; justify-content: space-around; padding: 12px; z-index: 999; }
        .dock-item { color: #94a3b8; text-decoration: none; text-align: center; font-size: 10px; font-weight: 600; }
        .dock-item.active { color: var(--p); }
        .dock-item i { font-size: 20px; margin-bottom: 4px; display: block; }

        /* Real-time Job Progress Bar */
        .progress-line { height: 4px; background: #e2e8f0; border-radius: 10px; margin: 15px 0; position: relative; }
        .progress-fill { height: 100%; background: var(--p); width: 0%; border-radius: 10px; transition: 1s; }
    </style>
</head>
<body>

    <div id="preloader">
        <h1 class="fw-800">Sewa<span style="color:var(--p)">Astra</span></h1>
        <div class="spinner-border text-warning" role="status"></div>
    </div>

    <div id="login-pg" class="page active-page container py-5 text-center">
        <div class="mt-5 pt-5">
            <h1 class="display-3 fw-800">Welcome<span style="color:var(--p)">.</span></h1>
            <p class="text-muted lead">SewaAstra Professional Partner Portal</p>
            <div class="u-card mt-5 mx-auto" style="max-width: 400px;">
                <button class="btn btn-dark w-100 py-3 rounded-4" onclick="handleAuth()">
                    <img src="https://img.icons8.com/color/24/google-logo.png" class="me-2"> Google Login
                </button>
            </div>
        </div>
    </div>

    <div id="dash-pg" class="page">
        <div class="container py-4">
            <div class="wallet-master">
                <div class="d-flex justify-content-between">
                    <div>
                        <small class="opacity-75 fw-bold text-uppercase">Net Earnings</small>
                        <h1 id="wall-bal" class="display-4 fw-800">₹0.00</h1>
                    </div>
                    <button class="btn btn-light btn-sm rounded-pill px-3 fw-bold h-25" onclick="cashout()">Withdraw</button>
                </div>
                <div class="mt-4 row">
                    <div class="col-6 border-end border-secondary"><small class="opacity-50">Jobs Done</small><h4 id="jobs-done" class="m-0">0</h4></div>
                    <div class="col-6 ps-4"><small class="opacity-50">Rating</small><h4 class="m-0">4.9 ★</h4></div>
                </div>
            </div>

            <h5 class="fw-800 mb-4 px-2">Live Opportunities</h5>
            <div id="feed-container">
                </div>
        </div>

        <div class="nav-dock">
            <a href="#" class="dock-item active"><i class="fa fa-briefcase"></i>Jobs</a>
            <a href="#" class="dock-item" onclick="showHistory()"><i class="fa fa-history"></i>History</a>
            <a href="#" class="dock-item" onclick="logout()"><i class="fa fa-power-off text-danger"></i>Exit</a>
        </div>
    </div>

    <div class="modal fade" id="verifyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-5 border-0 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <h3 class="fw-800">Job Complete?</h3>
                    <p class="text-muted">Enter the 4-digit code provided by customer</p>
                    <input type="number" id="otp-code" class="form-control form-control-lg text-center my-4 border-0 bg-light py-3 rounded-4 fw-bold fs-1" placeholder="0000" style="letter-spacing: 12px;">
                    <button class="btn-sewa" id="confirm-job-btn">Release Payment</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, increment, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG (SAME AS CUSTOMER APP)
        const firebaseConfig = {
            apiKey: "AIzaSyAL9dsBvNrp-ijxAk7ZYZcbN0BPaZ5gYtw",
            authDomain: "sewaastra.firebaseapp.com",
            projectId: "sewaastra",
            storageBucket: "sewaastra.firebasestorage.app",
            messagingSenderId: "211091351218",
            appId: "1:211091351218:web:47fe25d6db3e8dd0464bab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let userState = null;
        let activeJobId = null;

        window.navigate = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
        };

        window.handleAuth = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('preloader').style.display = 'none';
            if (user) {
                userState = user;
                const pRef = doc(db, "partners", user.uid);
                const pSnap = await getDoc(pRef);
                if (!pSnap.exists()) {
                    await setDoc(pRef, { name: user.displayName, wallet: 0, uid: user.uid, totalJobs: 0, joined: new Date().toISOString() });
                }
                navigate('dash-pg');
                initSync();
            } else {
                navigate('login-pg');
            }
        });

        function initSync() {
            // Sync Wallet
            onSnapshot(doc(db, "partners", userState.uid), d => {
                document.getElementById('wall-bal').innerText = `₹${d.data().wallet.toFixed(2)}`;
                document.getElementById('jobs-done').innerText = d.data().totalJobs;
            });

            // Global Job Sync (Connects with Customer & Admin Bookings)
            onSnapshot(query(collection(db, "bookings"), orderBy("createdAt", "desc")), snap => {
                const feed = document.getElementById('feed-container');
                feed.innerHTML = "";
                snap.forEach(res => {
                    const job = res.data();
                    const id = res.id;
                    if(job.status === 'open' || (job.status === 'active' && job.partnerId === userState.uid)) {
                        const isMyJob = job.status === 'active';
                        feed.innerHTML += `
                            <div class="u-card">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="status-pill ${isMyJob ? 'st-active' : 'st-open'}">${job.status}</span>
                                    <h5 class="fw-800 m-0">₹${job.price}</h5>
                                </div>
                                <h6 class="fw-800 mb-1 text-dark">${job.type || job.serviceName}</h6>
                                <p class="small text-muted mb-3"><i class="fa fa-location-dot me-1 text-primary"></i> ${job.address}</p>
                                ${isMyJob ? `
                                    <div class="d-flex gap-2">
                                        <button onclick="window.open('https://www.google.com/maps/search/${encodeURIComponent(job.address)}')" class="btn btn-light flex-fill rounded-3 fw-bold">Map</button>
                                        <button onclick="openVerify('${id}')" class="btn btn-dark flex-fill rounded-3 fw-bold">Finish Job</button>
                                    </div>
                                ` : `
                                    <button onclick="takeJob('${id}')" class="btn-sewa py-2">Take Job</button>
                                `}
                            </div>`;
                    }
                });
            });
        }

        window.takeJob = async (id) => {
            const otp = Math.floor(1000 + Math.random() * 9000);
            await updateDoc(doc(db, "bookings", id), {
                status: 'active',
                partnerId: userState.uid,
                otp: otp,
                acceptedAt: new Date().toISOString()
            });
            Swal.fire('Job Started!', `Customer OTP is: ${otp}`, 'success');
        };

        window.openVerify = (id) => {
            activeJobId = id;
            new bootstrap.Modal(document.getElementById('verifyModal')).show();
        };

        document.getElementById('confirm-job-btn').onclick = async () => {
            const code = document.getElementById('otp-code').value;
            const jRef = doc(db, "bookings", activeJobId);
            const jSnap = await getDoc(jRef);
            if(code == jSnap.data().otp) {
                const price = parseFloat(jSnap.data().price);
                const commission = price * 0.15; // 15% Admin
                const payout = price - commission;

                await updateDoc(doc(db, "partners", userState.uid), { wallet: increment(payout), totalJobs: increment(1) });
                await updateDoc(jRef, { status: 'completed', commission: commission, partnerPay: payout, endedAt: new Date().toISOString() });
                
                Swal.fire('Paid!', `₹${payout} added to your wallet.`, 'success').then(() => location.reload());
            } else {
                Swal.fire('Error', 'Incorrect Verification Code', 'error');
            }
        };

        window.cashout = () => Swal.fire('Request Sent', 'Payment will be sent to your UPI in 2 hours', 'success');

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
